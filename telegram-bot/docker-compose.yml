version: '3.8'

services:
  telegram-bot:
    build: .
    container_name: bestupid-telegram-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - OWNER_CHAT_ID=${OWNER_CHAT_ID}
      - PROJECT_ROOT=/project
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HISTORY_DIR=/project/.bestupid-private
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-haiku-4-5-20251001}
      - DAILY_TOKEN_BUDGET=${DAILY_TOKEN_BUDGET:-1000000}
      - TZ=America/New_York
    volumes:
      # Mount the repo read-write - this is the ONLY host access
      - ../:/project
      # Mount git credentials for push/pull
      - ${HOME}/.gitconfig:/home/botuser/.gitconfig-mount:ro
      - ${HOME}/.ssh:/home/botuser/.ssh-mount:ro
      # Sync timezone with host
      - /etc/localtime:/etc/localtime:ro
    working_dir: /project
    # No ports exposed - outbound polling only
    # No privileged access
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW      # Needed for network polling
      - SETUID       # Needed for gosu privilege drop
      - SETGID       # Needed for gosu privilege drop
